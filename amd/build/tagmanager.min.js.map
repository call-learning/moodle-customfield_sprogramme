{"version":3,"file":"tagmanager.min.js","sources":["../src/tagmanager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module tagmanager\n *\n * @module     customfield_sprogramme/tagmanager\n * @copyright  2025 Bas Brands <bas@sonsbeekmedia.nl>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport State from 'customfield_sprogramme/local/state';\nimport Repository from 'customfield_sprogramme/local/repository';\nimport Templates from 'core/templates';\nimport {getString} from 'core/str';\n\nclass TagManager {\n\n    modules = [];\n\n    /**\n     * Constructor.\n     */\n    constructor() {\n        this.addEventListeners();\n        this.fetchTags();\n    }\n\n    /**\n     * Set the modules.\n     * @param {Array} modules The modules.\n     */\n    async setModules(modules) {\n        this.modules = modules;\n    }\n\n    /**\n     * Fetch the tags.\n     */\n    async fetchTags() {\n        const tags = await Repository.getTags();\n        State.setValue('tags', tags);\n    }\n\n    /**\n     * Add event listeners.\n     */\n    addEventListeners() {\n        document.addEventListener('click', (e) => {\n            let btn = e.target.closest('[data-region=\"app\"] [data-action]');\n            if (btn) {\n                e.preventDefault();\n                this.actions(btn);\n            }\n        });\n    }\n\n    /**\n     * Handle actions.\n     * @param {HTMLElement} btn The button.\n     */\n    actions(btn) {\n        const actionMap = {\n            'adddisc': this.showDisciplineForm,\n            'addcomp': this.showCompetenciesForm,\n            'removetag': this.removeTag,\n            'closetagform': this.closeTagForm,\n            'selecttag': this.selectTag,\n            'tag-confirm': this.addTag,\n            'loadtag': this.loadTag,\n        };\n        const action = btn.dataset.action;\n        if (actionMap[action]) {\n            actionMap[action].call(this, btn);\n        }\n    }\n\n    /**\n     * Get the position of a row in a module\n     * if the row is within the first 8 rows, return the rowid of the first row.\n     * if the row is the 8th row or higher, return the rowid of the row minus 8.\n     * @param {String} rowId The row id.\n     * @returns {Int} The rowId of the target row.\n     */\n    getTargetRow(rowId) {\n        const modules = State.getValue('modules');\n        if (!modules || modules.length === 0) {\n            return 0;\n        }\n\n        for (const module of modules) {\n            const rowFound = module.rows.find(row => row.id === parseInt(rowId));\n            if (rowFound) {\n                const position = module.rows.indexOf(rowFound);\n                if (position < 6) {\n                    const row = module.rows[0];\n                    return row ? row.id : 0;\n                } else {\n                    return module.rows[position - 6].id;\n                }\n            }\n        }\n        return 0; // Row not found in any module.\n    }\n\n    /**\n     * Get the number of pixels to shift the arrow downwards.\n     * @param {String} rowId The row id.\n     * @param {Int} position The position of the row the form is attached to.\n     * @param {String} type The type of tag (disciplines or competencies).\n     * @returns {Int} The number of pixels to shift the arrow downwards.\n     */\n    getRowOffset(rowId, position, type) {\n        if (parseInt(rowId) === position || position === 0) {\n            return 0; // No offset needed if the row is the target row.\n        }\n        const target = document.querySelector(`[data-${type}][data-rowid=\"${position}\"]`);\n        const row = document.querySelector(`[data-${type}][data-rowid=\"${rowId}\"]`);\n        if (!target || !row) {\n            return 0; // If the target or row is not found, no offset needed.\n        }\n        const targetRect = target.getBoundingClientRect();\n        const rowRect = row.getBoundingClientRect();\n        // Calculate the offset based on the target and row positions.\n        const offset = rowRect.top - targetRect.top;\n        return offset;\n    }\n\n    /**\n     * Get the row from the state.\n     * @param {int} rowid The rowid.\n     */\n    getRow(rowid) {\n        const modules = State.getValue('modules');\n        // Combine all rows in one array.\n        const rows = modules.reduce((acc, module) => {\n            return acc.concat(module.rows);\n        }, []);\n        const row = rows.find(r => r.id == rowid);\n        return row;\n    }\n\n    /**\n     * Get the tags from the current row.\n     * @param {String} rowId The row id.\n     * @param {String} type The type of tags to get.\n     */\n    getTagsFromRow(rowId, type) {\n        const row = this.getRow(rowId);\n        if (!row || !row[type]) {\n            return [];\n        }\n        return row[type];\n    }\n\n    /**\n     * Show the discipline form.\n     * @param {HTMLElement} btn The button.\n     */\n    async showDisciplineForm(btn) {\n        const rowId = btn.dataset.id;\n        this.closeTagForm();\n        this.renderForm(rowId, 'disciplines');\n    }\n\n    /**\n     * Show the competencies form.\n     * @param {HTMLElement} btn The button.\n     */\n    async showCompetenciesForm(btn) {\n        const rowId = btn.dataset.id;\n        this.closeTagForm();\n        this.renderForm(rowId, 'competencies');\n    }\n\n    /**\n     * Render the form\n     * @param {Number} rowId The row id.\n     * @param {String} type The type of tag to render.\n     * @returns {Promise<String>} The rendered form.\n     */\n    async renderForm(rowId, type) {\n        const setTags = this.getTagsFromRow(rowId, type);\n        const position = this.getTargetRow(rowId);\n        const arrowOffset = this.getRowOffset(rowId, position, type);\n        const tags = State.getValue('tags');\n        const target = document.querySelector(`[data-${type}][data-rowid=\"${position}\"]`);\n        const maxTagsReached = this.isMaxTagsReached(rowId, type);\n        const {html, js} = await Templates.renderForPromise('customfield_sprogramme/tagform', {\n            tagtype: type,\n            taglist: tags[type],\n            rowid: rowId,\n            settags: setTags,\n            hasmaxtags: maxTagsReached,\n            arrowoffset: arrowOffset,\n        });\n        await Templates.appendNodeContents(target, html, js);\n    }\n\n    /**\n     * Check if the maximum number of tags is reached for the given type.\n     * @param {Number} rowId The row id.\n     * @param {String} type The type of tag to render.\n     * @returns {boolean} True if the maximum number of tags is reached, false otherwise\n     */\n    isMaxTagsReached(rowId, type) {\n        const row = this.getRow(rowId);\n        if (!row || !row[type]) {\n            return false;\n        }\n        const config = {\n            'disciplines': 3,\n            'competencies': 100,\n        };\n        return row[type].length >= config[type];\n    }\n\n\n    /**\n     * Destroy the discipline form.\n     */\n    closeTagForm() {\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        if (form) {\n            form.remove();\n        }\n    }\n\n    /**\n     * Set the tag form with the given discipline.\n     * @param {Object} tag The tag.\n     */\n    setTagForm(tag) {\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        if (!form) {\n            return;\n        }\n        const input = form.querySelector('input[type=\"search\"]');\n        if (input) {\n            input.value = tag.name;\n        }\n        const tagId = form.querySelector('#tag-id');\n        if (tagId) {\n            tagId.value = tag.id;\n        }\n        const select = form.querySelector('#tag-value');\n        if (select) {\n            select.focus();\n        }\n    }\n\n    /**\n     * Select a tag.\n     * @param {HTMLElement} btn The button.\n     */\n    selectTag(btn) {\n        const option = btn.closest('[data-option]');\n        const tag = {\n            id: option.dataset.id,\n            name: option.textContent,\n        };\n        this.setTagForm(tag);\n    }\n\n    /**\n     * Get a tag from the State tags.\n     *\n     * @param {String} tagId The tag id.\n     * @param {String} type The type of tag to get.\n     * traverse the tags in the state and return the tag with the given id.\n     */\n    getTag(tagId, type) {\n        const tags = State.getValue('tags');\n        if (!tags || !tags[type]) {\n            return null;\n        }\n        // Construct a flat array of tags.\n        const flatTags = tags[type].reduce((acc, tag) => {\n            acc.push(tag);\n            if (tag.items && tag.items.length > 0) {\n                acc.push(...tag.items);\n            }\n            return acc;\n        }, []);\n        // Find the tag with the given id.\n        return flatTags.find(tag => tag.uniqueid === parseInt(tagId) || tag.id === parseInt(tagId));\n    }\n\n\n    /**\n     * Add a tag selected in the tagform.\n     */\n    async addTag() {\n        const modules = State.getValue('modules');\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        const warnings = form.querySelector('[data-region=\"warnings\"]');\n        if (!form) {\n            return;\n        }\n\n        const rowId = form.dataset.rowid;\n        const type = form.dataset.type;\n        const tagId = parseInt(form.querySelector('#tag-id').value);\n        const tagValue = parseInt(form.querySelector('#tag-value').value);\n\n        if (!tagId || !tagValue) {\n            return;\n        }\n\n        // Find name of the tag.\n        const selectedTag = this.getTag(tagId, type);\n        if (!selectedTag) {\n            return;\n        }\n\n        // Add the tag to the row.\n        const row = this.getRow(rowId);\n        if (!row) {\n            return;\n        }\n        if (!row[type]) {\n            row[type] = [];\n        }\n\n        // Validate the value, the maximum value is 100 and the total of all tags should not exceed 100.\n        const maxPercentage = 100 - row[type].reduce((acc, tag) => acc + parseInt(tag.percentage), 0);\n        if (parseInt(tagValue) > maxPercentage) {\n            warnings.innerHTML = await getString('maxpercentage', 'customfield_sprogramme', maxPercentage);\n            return;\n        } else {\n            warnings.innerHTML = '';\n        }\n\n        // Check if the tag already exists in the row.\n        const existingTags = this.getTagsFromRow(rowId, type);\n        if (!existingTags) {\n            row[type] = [];\n        }\n        const existingTag = existingTags.find(tag => tag.id === tagId || tag.uniqueid === tagId);\n        if (existingTag) {\n            existingTag.percentage = tagValue;\n        } else {\n            const tag = {\n                id: tagId,\n                name: selectedTag ? selectedTag.name : 'Unknown',\n                percentage: tagValue,\n            };\n            row[type].push(tag);\n        }\n\n        // Might need to avoid this. it hides the tag form.\n        State.setValue('modules', modules);\n    }\n\n    /**\n     * Remove a tag from the row.\n     * @param {HTMLElement} btn The button.\n     */\n    async removeTag(btn) {\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        if (!form) {\n            return;\n        }\n        const type = form.dataset.type;\n        const rowId = parseInt(form.dataset.rowid);\n        const tagId = parseInt(btn.dataset.id);\n\n        const modules = State.getValue('modules');\n        const row = this.getRow(rowId);\n        if (!row || !row[type]) {\n            return;\n        }\n        // Remove the tag from the row.\n        row[type] = row[type].filter(tag => tag.id !== parseInt(tagId));\n        // Update the state.\n        State.setValue('modules', modules);\n    }\n\n\n    /**\n     * Load a tag into the tag form.\n     * @param {HTMLElement} btn The button.\n     */\n    async loadTag(btn) {\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        if (!form) {\n            return;\n        }\n        form.querySelector('#tag-id').value = btn.dataset.id;\n        form.querySelector('#tag-value').value = btn.dataset.percentage;\n        form.querySelector('#tag-name').value = btn.dataset.name;\n        form.querySelector('#tag-value').focus();\n    }\n\n    /**\n     * Disable the form input.\n     * @param {boolean} disable Whether to disable the form input.\n     */\n    disableFormInput(disable = true) {\n        const form = document.querySelector('[data-region=\"tagform\"]');\n        if (!form) {\n            return;\n        }\n        const input = form.querySelector('#tag-name');\n        if (input) {\n            input.disabled = disable;\n        }\n        const value = form.querySelector('#tag-value');\n        if (value) {\n            value.disabled = disable;\n        }\n        const submit = form.querySelector('[data-action=\"tag-confirm\"]');\n        if (submit) {\n            submit.disabled = disable;\n        }\n    }\n}\nnew TagManager();\n"],"names":["constructor","addEventListeners","fetchTags","modules","tags","Repository","getTags","setValue","document","addEventListener","e","btn","target","closest","preventDefault","actions","actionMap","this","showDisciplineForm","showCompetenciesForm","removeTag","closeTagForm","selectTag","addTag","loadTag","action","dataset","call","getTargetRow","rowId","State","getValue","length","module","rowFound","rows","find","row","id","parseInt","position","indexOf","getRowOffset","type","querySelector","targetRect","getBoundingClientRect","top","getRow","rowid","reduce","acc","concat","r","getTagsFromRow","renderForm","setTags","arrowOffset","maxTagsReached","isMaxTagsReached","html","js","Templates","renderForPromise","tagtype","taglist","settags","hasmaxtags","arrowoffset","appendNodeContents","form","remove","setTagForm","tag","input","value","name","tagId","select","focus","option","textContent","getTag","push","items","uniqueid","warnings","tagValue","selectedTag","maxPercentage","percentage","innerHTML","existingTags","existingTag","filter","disableFormInput","disable","disabled","submit"],"mappings":"saAkCIA,sCALU,0IAMDC,yBACAC,6BAOQC,cACRA,QAAUA,gCAOTC,WAAaC,oBAAWC,yBACxBC,SAAS,OAAQH,MAM3BH,oBACIO,SAASC,iBAAiB,SAAUC,QAC5BC,IAAMD,EAAEE,OAAOC,QAAQ,qCACvBF,MACAD,EAAEI,sBACGC,QAAQJ,SASzBI,QAAQJ,WACEK,UAAY,SACHC,KAAKC,2BACLD,KAAKE,+BACHF,KAAKG,uBACFH,KAAKI,uBACRJ,KAAKK,wBACHL,KAAKM,eACTN,KAAKO,SAEdC,OAASd,IAAIe,QAAQD,OACvBT,UAAUS,SACVT,UAAUS,QAAQE,KAAKV,KAAMN,KAWrCiB,aAAaC,aACH1B,QAAU2B,eAAMC,SAAS,eAC1B5B,SAA8B,IAAnBA,QAAQ6B,cACb,MAGN,MAAMC,UAAU9B,QAAS,OACpB+B,SAAWD,OAAOE,KAAKC,MAAKC,KAAOA,IAAIC,KAAOC,SAASV,YACzDK,SAAU,OACJM,SAAWP,OAAOE,KAAKM,QAAQP,aACjCM,SAAW,EAAG,OACRH,IAAMJ,OAAOE,KAAK,UACjBE,IAAMA,IAAIC,GAAK,SAEfL,OAAOE,KAAKK,SAAW,GAAGF,WAItC,EAUXI,aAAab,MAAOW,SAAUG,SACtBJ,SAASV,SAAWW,UAAyB,IAAbA,gBACzB,QAEL5B,OAASJ,SAASoC,8BAAuBD,8BAAqBH,gBAC9DH,IAAM7B,SAASoC,8BAAuBD,8BAAqBd,iBAC5DjB,SAAWyB,WACL,QAELQ,WAAajC,OAAOkC,+BACVT,IAAIS,wBAEGC,IAAMF,WAAWE,IAQ5CC,OAAOC,cACanB,eAAMC,SAAS,WAEVmB,QAAO,CAACC,IAAKlB,SACvBkB,IAAIC,OAAOnB,OAAOE,OAC1B,IACcC,MAAKiB,GAAKA,EAAEf,IAAMW,QASvCK,eAAezB,MAAOc,YACZN,IAAMpB,KAAK+B,OAAOnB,cACnBQ,KAAQA,IAAIM,MAGVN,IAAIM,MAFA,4BASUhC,WACfkB,MAAQlB,IAAIe,QAAQY,QACrBjB,oBACAkC,WAAW1B,MAAO,0CAOAlB,WACjBkB,MAAQlB,IAAIe,QAAQY,QACrBjB,oBACAkC,WAAW1B,MAAO,iCASVA,MAAOc,YACda,QAAUvC,KAAKqC,eAAezB,MAAOc,MACrCH,SAAWvB,KAAKW,aAAaC,OAC7B4B,YAAcxC,KAAKyB,aAAab,MAAOW,SAAUG,MACjDvC,KAAO0B,eAAMC,SAAS,QACtBnB,OAASJ,SAASoC,8BAAuBD,8BAAqBH,gBAC9DkB,eAAiBzC,KAAK0C,iBAAiB9B,MAAOc,OAC9CiB,KAACA,KAADC,GAAOA,UAAYC,mBAAUC,iBAAiB,iCAAkC,CAClFC,QAASrB,KACTsB,QAAS7D,KAAKuC,MACdM,MAAOpB,MACPqC,QAASV,QACTW,WAAYT,eACZU,YAAaX,oBAEXK,mBAAUO,mBAAmBzD,OAAQgD,KAAMC,IASrDF,iBAAiB9B,MAAOc,YACdN,IAAMpB,KAAK+B,OAAOnB,WACnBQ,MAAQA,IAAIM,aACN,SAMJN,IAAIM,MAAMX,QAJF,aACI,eACC,KAEcW,MAOtCtB,qBACUiD,KAAO9D,SAASoC,cAAc,2BAChC0B,MACAA,KAAKC,SAQbC,WAAWC,WACDH,KAAO9D,SAASoC,cAAc,+BAC/B0B,kBAGCI,MAAQJ,KAAK1B,cAAc,wBAC7B8B,QACAA,MAAMC,MAAQF,IAAIG,YAEhBC,MAAQP,KAAK1B,cAAc,WAC7BiC,QACAA,MAAMF,MAAQF,IAAInC,UAEhBwC,OAASR,KAAK1B,cAAc,cAC9BkC,QACAA,OAAOC,QAQfzD,UAAUX,WACAqE,OAASrE,IAAIE,QAAQ,iBACrB4D,IAAM,CACRnC,GAAI0C,OAAOtD,QAAQY,GACnBsC,KAAMI,OAAOC,kBAEZT,WAAWC,KAUpBS,OAAOL,MAAOlC,YACJvC,KAAO0B,eAAMC,SAAS,YACvB3B,OAASA,KAAKuC,aACR,YAGMvC,KAAKuC,MAAMO,QAAO,CAACC,IAAKsB,OACrCtB,IAAIgC,KAAKV,KACLA,IAAIW,OAASX,IAAIW,MAAMpD,OAAS,GAChCmB,IAAIgC,QAAQV,IAAIW,OAEbjC,MACR,IAEaf,MAAKqC,KAAOA,IAAIY,WAAa9C,SAASsC,QAAUJ,IAAInC,KAAOC,SAASsC,8BAQ9E1E,QAAU2B,eAAMC,SAAS,WACzBuC,KAAO9D,SAASoC,cAAc,2BAC9B0C,SAAWhB,KAAK1B,cAAc,gCAC/B0B,kBAICzC,MAAQyC,KAAK5C,QAAQuB,MACrBN,KAAO2B,KAAK5C,QAAQiB,KACpBkC,MAAQtC,SAAS+B,KAAK1B,cAAc,WAAW+B,OAC/CY,SAAWhD,SAAS+B,KAAK1B,cAAc,cAAc+B,WAEtDE,QAAUU,sBAKTC,YAAcvE,KAAKiE,OAAOL,MAAOlC,UAClC6C,yBAKCnD,IAAMpB,KAAK+B,OAAOnB,WACnBQ,WAGAA,IAAIM,QACLN,IAAIM,MAAQ,UAIV8C,cAAgB,IAAMpD,IAAIM,MAAMO,QAAO,CAACC,IAAKsB,MAAQtB,IAAMZ,SAASkC,IAAIiB,aAAa,MACvFnD,SAASgD,UAAYE,0BACrBH,SAASK,gBAAkB,kBAAU,gBAAiB,yBAA0BF,gBAGhFH,SAASK,UAAY,SAInBC,aAAe3E,KAAKqC,eAAezB,MAAOc,MAC3CiD,eACDvD,IAAIM,MAAQ,UAEVkD,YAAcD,aAAaxD,MAAKqC,KAAOA,IAAInC,KAAOuC,OAASJ,IAAIY,WAAaR,WAC9EgB,YACAA,YAAYH,WAAaH,aACtB,OACGd,IAAM,CACRnC,GAAIuC,MACJD,KAAMY,YAAcA,YAAYZ,KAAO,UACvCc,WAAYH,UAEhBlD,IAAIM,MAAMwC,KAAKV,oBAIblE,SAAS,UAAWJ,yBAOdQ,WACN2D,KAAO9D,SAASoC,cAAc,+BAC/B0B,kBAGC3B,KAAO2B,KAAK5C,QAAQiB,KACpBd,MAAQU,SAAS+B,KAAK5C,QAAQuB,OAC9B4B,MAAQtC,SAAS5B,IAAIe,QAAQY,IAE7BnC,QAAU2B,eAAMC,SAAS,WACzBM,IAAMpB,KAAK+B,OAAOnB,OACnBQ,KAAQA,IAAIM,QAIjBN,IAAIM,MAAQN,IAAIM,MAAMmD,QAAOrB,KAAOA,IAAInC,KAAOC,SAASsC,wBAElDtE,SAAS,UAAWJ,wBAQhBQ,WACJ2D,KAAO9D,SAASoC,cAAc,2BAC/B0B,OAGLA,KAAK1B,cAAc,WAAW+B,MAAQhE,IAAIe,QAAQY,GAClDgC,KAAK1B,cAAc,cAAc+B,MAAQhE,IAAIe,QAAQgE,WACrDpB,KAAK1B,cAAc,aAAa+B,MAAQhE,IAAIe,QAAQkD,KACpDN,KAAK1B,cAAc,cAAcmC,SAOrCgB,uBAAiBC,yEACP1B,KAAO9D,SAASoC,cAAc,+BAC/B0B,kBAGCI,MAAQJ,KAAK1B,cAAc,aAC7B8B,QACAA,MAAMuB,SAAWD,eAEfrB,MAAQL,KAAK1B,cAAc,cAC7B+B,QACAA,MAAMsB,SAAWD,eAEfE,OAAS5B,KAAK1B,cAAc,+BAC9BsD,SACAA,OAAOD,SAAWD"}