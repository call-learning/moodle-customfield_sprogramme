define("customfield_sprogramme/manager",["exports","customfield_sprogramme/local/state","customfield_sprogramme/local/repository","core/templates","core/notification","core/str","core/utils","./local/components/table"],(function(_exports,_state,_repository,_templates,_notification,_str,_utils,_table){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);class Manager{constructor(element,courseid){_defineProperty(this,"rowNumber",0),_defineProperty(this,"moduleNumber",0),_defineProperty(this,"courseid",void 0),_defineProperty(this,"element",void 0),_defineProperty(this,"table","customfield_sprogramme"),_defineProperty(this,"columns",[]),this.element=element,this.element.dataset.inintialized||(this.courseid=parseInt(courseid),this.addEventListeners(),this.getTableData(),this.element.dataset.inintialized=!0)}addEventListeners(){const form=document.querySelector('[data-region="app"]');form.addEventListener("click",(e=>{let btn=e.target.closest("[data-action]");if(btn)e.preventDefault(),this.actions(btn);else{form.querySelectorAll('[data-action="showchanges"]').forEach((td=>{td.classList.remove("active")}))}})),form.addEventListener("change",(e=>{const input=e.target.closest('[data-input="auto"]');input&&this.change(input);const modulename=e.target.closest('[data-region="modulename"]');modulename&&this.changeModule(modulename)})),form.addEventListener("keydown",(e=>{"ArrowDown"!==e.key&&"ArrowUp"!==e.key||(this.navigate(e),e.preventDefault()),"Enter"===e.key&&e.preventDefault()})),form.addEventListener("submit",(e=>{e.preventDefault()}));let dragging=null,isDraggingAllowed=!1;form.addEventListener("mousedown",(e=>{isDraggingAllowed=!!e.target.closest('[data-region="dragicon"]')})),form.addEventListener("dragstart",(e=>{isDraggingAllowed||e.preventDefault(),"TR"===e.target.tagName&&(dragging=e.target,e.target.effectAllowed="move")})),form.addEventListener("dragover",(e=>{e.preventDefault();const target=e.target.closest("tr");if(target&&target!==dragging&&"rows"===target.parentNode.dataset.region){const rect=target.getBoundingClientRect();e.clientY-rect.top>rect.height/2?target.parentNode.insertBefore(dragging,target.nextSibling):target.parentNode.insertBefore(dragging,target)}})),form.addEventListener("drop",(e=>{e.preventDefault()})),form.addEventListener("dragend",(e=>{const rowId=dragging.dataset.index,prevRowId=dragging.previousElementSibling?dragging.previousElementSibling.dataset.index:0,moduleId=dragging.closest('[data-region="module"]').dataset.id;this.moveRow(parseInt(moduleId),parseInt(rowId),prevRowId?parseInt(prevRowId):null),dragging=null,e.preventDefault()}));document.querySelector('[data-region="disciplineform"]').querySelector('input[type="search"]').addEventListener("input",(e=>{const input=e.target.closest("input");input&&this.typeahead(input)})),document.addEventListener("saveconfirm",(()=>{this.setTableData()}))}async getTableData(){try{const response=await _repository.default.getData({courseid:this.courseid,showrfc:1});if(response.modules.length>0){const modules=this.parseModules(response.modules),columns=modules[0].columns;_state.default.setValue("columns",[...columns]),_state.default.setValue("modules",modules),_state.default.setValue("rfcs",response.rfcs)}else this.addModule(),this.getTableData()}catch(error){_notification.default.exception(error)}}parseModules(modules){return modules.forEach((mod=>{mod.rows.map((row=>(row.cells=row.cells.map((cell=>{const column=mod.columns.find((column=>column.column==cell.column));return"select"===(cell=Object.assign({},cell,column)).type&&(cell.options=cell.options.map((option=>{const clonedOption=Object.assign({},option);return clonedOption.name==cell.value&&(clonedOption.selected=!0),clonedOption}))),cell.edit=!0,cell})),row)))})),modules}getRowObject(){return{rows:{id:"id",sortorder:"sortorder",deleted:"false",cells:{type:"type",column:"column",value:"value"},disciplines:{id:"id",name:"name",percentage:"percentage"},competencies:{id:"id",name:"name",percentage:"percentage"}}}}checkCellValue(cell){null!==cell.value&&"text"===cell.type&&cell.value.length>cell.length&&(cell.value=cell.value.substring(0,cell.length))}cleanCell(cell,cellKeys){const cleaned={};return this.checkCellValue(cell),cellKeys.forEach((key=>{cleaned[key]=cell[key]})),cleaned}cleanList(items,allowedKeys){return items.map((item=>{const cleaned={};return allowedKeys.forEach((key=>{cleaned[key]=item[key]})),cleaned}))}cleanModules(modules){const rowSpec=this.getRowObject().rows;return modules.map((module=>({id:module.moduleid,name:module.modulename,sortorder:module.modulesortorder,deleted:module.deleted||!1,rows:module.rows.map((row=>({id:row.id,sortorder:row.sortorder,deleted:row.deleted||!1,cells:this.cleanList(row.cells,Object.keys(rowSpec.cells)),disciplines:this.cleanList(row.disciplines,Object.keys(rowSpec.disciplines)),competencies:this.cleanList(row.competencies,Object.keys(rowSpec.competencies))})))})))}async setTableData(){(0,_utils.debounce)((async()=>{const saveConfirmButton=document.querySelector('[data-action="saveconfirm"]'),warnings=document.querySelector('[data-region="sprogramme-warnings"]');saveConfirmButton.classList.add("saving");const modules=_state.default.getValue("modules"),cleanedModules=this.cleanModules(modules),response=await _repository.default.setData({courseid:this.courseid,modules:cleanedModules});if(response){"rfclocked"==response.data?(warnings.innerHTML=await(0,_str.getString)("rfclocked","customfield_sprogramme"),warnings.classList.remove("d-none")):(warnings.innerHTML="",warnings.classList.add("d-none")),this.getTableData();const modulesStatic=_state.default.getValue("modules");_state.default.setValue("modulesstatic",modulesStatic)}else _notification.default.exception("No response from the server");setTimeout((()=>{saveConfirmButton.classList.remove("saving")}),200)}),600)()}actions(btn){const actionMap={addrow:this.addRow,deleterow:this.deleteRow,addmodule:this.addModule,deletemodule:this.deleteModule,adddisc:this.showDisciplineForm,addcomp:this.showDisciplineForm,removedisc:this.removeDiscipline,closedisciplineform:this.closeDisciplineForm,selectdiscipline:btn=>{const option=btn.closest("[data-option]"),discipline={id:option.dataset.id,name:option.textContent};this.setDisciplineForm(discipline)},"discipline-confirm":this.addDiscipline,saveconfirm:this.setTableData,loaddiscipline:this.loadDiscipline,showchanges:this.showchanges,acceptrfc:this.acceptRfc,rejectrfc:this.rejectRfc,submitrfc:this.submitRfc,cancelrfc:this.cancelRfc,removerfc:this.removeRfc,augmenttable:this.augmentTable,resetrfc:this.resetRfc},action=btn.dataset.action;actionMap[action]&&actionMap[action].call(this,btn)}async addRow(btn){const modules=_state.default.getValue("modules");let rowid=btn.dataset.id;const moduleid=btn.closest('[data-region="module"]').dataset.id,rows=modules.find((m=>m.moduleid==moduleid)).rows;-1==rowid&&(rowid=rows[rows.length-1].id);const row=await this.createRow();row&&(rows.splice(rows.indexOf(rows.find((r=>r.id==rowid)))+1,0,row),this.resetRowSortorder(),_state.default.setValue("modules",modules))}createRow(){const row={};row.id=this.rowNumber-1;const columns=_state.default.getValue("columns");return row.cells=columns.map((column=>structuredClone(column))),row.cells.forEach((cell=>{cell.edit=!0,cell.value="",cell[cell.type]=!0})),row.disciplines=[],row.competencies=[],row}async deleteRow(btn){const modules=_state.default.getValue("modules"),rowid=parseInt(btn.closest("[data-row]").dataset.index),moduleid=parseInt(btn.closest('[data-region="module"]').dataset.id),modulefound=modules.find((m=>m.moduleid==moduleid));if(modulefound.rows.length>0){const rowIndex=modulefound.rows.findIndex((r=>r.id==rowid));-1!==rowIndex?(modulefound.rows[rowIndex].deleted=!0,_state.default.setValue("modules",modules)):_notification.default.exception("Row not found")}}change(input){const row=input.closest("[data-row]"),cell=input.closest("[data-cell]"),group=input.dataset.group,value=input.value,columnid=parseInt(cell.dataset.columnid),index=parseInt(row.dataset.index);_state.default.getValue("modules").forEach((module=>{const rowIndex=module.rows.findIndex((r=>r.id==index));if(-1===rowIndex)return;const cellIndex=module.rows[rowIndex].cells.findIndex((c=>c.columnid==columnid));module.rows[rowIndex].cells[cellIndex].value=value,group&&module.rows[rowIndex].cells.forEach((c=>{c.group===group&&c.columnid!==columnid&&(c.value=null,row.querySelector('[data-columnid="'.concat(c.columnid,'"] input')).value=null)}))})),this.sumtotals()}sumtotals(){const form=document.querySelector('[data-region="app"]');form.querySelectorAll('[data-region="sumtotals"]').forEach((column=>{const columnid=column.dataset.columnid;let sum=0,containsRfc=!1;form.querySelectorAll('[data-columnid="'.concat(columnid,'"] input')).forEach((input=>{input.value&&(sum+=parseFloat(input.value),"1"===input.dataset.rfcstate&&(containsRfc=!0))})),sum=sum||"",column.innerHTML=sum,containsRfc&&(column.classList.add("rfc"),column.innerHTML=sum||0)}))}changeModule(input){const moduleid=input.closest('[data-region="module"]').dataset.id,name=input.value;_state.default.getValue("modules").forEach((module=>{module.moduleid==moduleid&&(module.modulename=name)}))}async deleteModule(btn){const moduleid=btn.closest('[data-region="module"]').dataset.id,modules=_state.default.getValue("modules"),moduleIndex=modules.findIndex((m=>m.moduleid==moduleid));-1!==moduleIndex&&(modules[moduleIndex].deleted=!0,_state.default.setValue("modules",modules))}async createModule(){return this.moduleNumber--}async addModule(){const modules=_state.default.getValue("modules"),module={moduleid:await this.createModule(),modulename:" ",rows:[this.createRow()]};modules.push(module),this.resetRowSortorder(),_state.default.setValue("modules",modules)}getRow(rowid){return _state.default.getValue("modules").reduce(((acc,module)=>acc.concat(module.rows)),[]).find((r=>r.id==rowid))}moveRow(moduleId,rowId,prevRowId){const modules=_state.default.getValue("modules"),module=modules.find((m=>m.moduleid===moduleId));if(!module)return;const rows=module.rows,rowIndex=rows.findIndex((r=>r.id===rowId));if(-1===rowIndex)return;const[rowToMove]=rows.splice(rowIndex,1);let insertIndex=0;if(null!==prevRowId){insertIndex=rows.findIndex((r=>r.id===prevRowId))+1}rows.splice(insertIndex,0,rowToMove),rows.forEach(((row,index)=>{row.sortorder=index+1})),_state.default.setValue("modules",modules)}resetRowSortorder(){const modules=_state.default.getValue("modules");modules.forEach(((module,mindex)=>{module.modulesortorder=mindex,module.rows.forEach(((row,index)=>{row.sortorder=index}))})),_state.default.setValue("modules",modules)}typeahead(input){const value=input.value;document.querySelector('[data-region="disciplineform"]').querySelectorAll("[data-option]").forEach((option=>{this.removeMatchBold(option),option.textContent.toLowerCase().includes(value.toLowerCase())?(option.classList.remove("d-none"),this.makeMatchBold(option,value)):option.classList.add("d-none")}))}makeMatchBold(option,value){const text=option.textContent,index=text.toLowerCase().indexOf(value.toLowerCase()),first=text.slice(0,index),match=text.slice(index,index+value.length),last=text.slice(index+value.length);option.innerHTML=first+"<strong>"+match+"</strong>"+last}removeMatchBold(option){option.innerHTML=option.textContent}async showDisciplineForm(btn){const btnAction=btn.dataset.action,region="adddisc"===btnAction?"data-disciplines":"data-competencies",row=btn.closest("[data-row]"),module=btn.closest('[data-region="module"]'),form=document.querySelector('[data-region="disciplineform"]');form.classList.remove("data-disciplines","data-competencies"),form.classList.add(region),form.querySelector("#rowid").value=row.dataset.index;const arrow=form.querySelector(".formarrow");form.querySelector("#discipline-value").value="",form.querySelector("#discipline-name").value="";const rows=module.querySelectorAll('[data-region="rows"] [data-row]'),rowArray=Array.from(rows),index=rowArray.indexOf(row);form.querySelector('[data-region="rownumber"]').textContent=await(0,_str.getString)("row","customfield_sprogramme",index+1),form.dataset.action=region;const setindex=index-8;let attachTo,attachToButton;setindex>0?(attachTo=rowArray[setindex].querySelector("[".concat(region,"]")),attachToButton=rowArray[setindex].querySelector('[data-action="'.concat(btnAction,'"]'))):(attachTo=rowArray[0].querySelector("[".concat(region,"]")),attachToButton=rowArray[0].querySelector('[data-action="'.concat(btnAction,'"]'))),attachTo.appendChild(form);const rectBtn=btn.getBoundingClientRect(),rectAttachToButton=attachToButton.getBoundingClientRect();arrow.style.top=rectBtn.top-rectAttachToButton.top+"px",this.renderFormDisciplines(row.dataset.index,region),this.disableFormInput(form)}closeDisciplineForm(){const container=document.querySelector('[data-region="disciplineform-container"]'),form=document.querySelector('[data-region="disciplineform"]');container.appendChild(form)}async setDisciplineForm(discipline){const form=document.querySelector('[data-region="disciplineform"]'),formFieldSearch=form.querySelector('input[type="search"]'),formFieldValue=form.querySelector("#discipline-value"),formFieldDiscipline=form.querySelector("#discipline-id"),formFieldDisciplineName=form.querySelector("#discipline-name"),formFieldLastIds=form.querySelector("#lastids");formFieldDiscipline.value=discipline.id,formFieldDisciplineName.value=discipline.name,formFieldSearch.value=discipline.name;const lastIds=formFieldLastIds.value.split(",");lastIds.includes(discipline.id)||(lastIds.push(discipline.id),formFieldLastIds.value=lastIds.join(",")),formFieldValue.focus()}async getSelectedDiscipline(form){const action=form.dataset.action,disciplineid=form.querySelector("#discipline-id").value,disciplinevalue=form.querySelector("#discipline-value").value,disciplinename=form.querySelector("#discipline-name").value;if(!disciplineid||!disciplinevalue||!disciplinename)return form.querySelector('[data-region="warnings"]').innerHTML="Invalid input",!1;const availableDisciplines=form.querySelectorAll('[data-list="'.concat(action,'"] [data-action="selectdiscipline"]')),listedDiscipline=Array.from(availableDisciplines).find((d=>d.dataset.id==disciplineid));if(!listedDiscipline||listedDiscipline.textContent!==disciplinename)return form.querySelector('[data-region="warnings"]').innerHTML=await(0,_str.getString)("invalidinput","customfield_sprogramme"),!1;const displine={id:disciplineid,name:disciplinename,percentage:parseInt(disciplinevalue)};return new Promise((resolve=>{resolve(displine)}))}loadDiscipline(btn){const form=document.querySelector('[data-region="disciplineform"]');form.querySelector("#discipline-id").value=btn.dataset.id,form.querySelector("#discipline-name").value=btn.dataset.name,form.querySelector("#discipline-value").value=btn.dataset.percentage,form.querySelector("#discipline-value").focus()}async showchanges(btn){document.querySelectorAll('[data-action="showchanges"]').forEach((td=>{td!==btn&&td.classList.remove("active")})),btn.classList.add("active")}async acceptRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.acceptRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async rejectRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.rejectRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async submitRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.submitRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async cancelRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.cancelRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async removeRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.removeRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async augmentTable(btn){const userid=btn.closest("[data-rfc]").dataset.userid,form=document.querySelector('[data-region="app"]'),resetRfc=form.querySelector('[data-action="resetrfc"]');this.resetRfc(resetRfc),resetRfc.classList.remove("d-none");form.querySelectorAll('[data-action="showchanges"]').forEach((cell=>{const input=cell.querySelector('[data-input="auto"]');if(input){input.dataset.input="rfc";const changesdiv=cell.querySelector('[data-changes][data-userid="'+userid+'"]');if(!changesdiv)return;const newvalue=changesdiv.dataset.newvalue;input.dataset.oldvalue=input.value,input.value=newvalue,input.dataset.rfcstate="1",cell.classList.add("rfc")}})),this.sumtotals()}async resetRfc(btn){document.querySelector('[data-region="app"]').querySelectorAll('[data-action="showchanges"]').forEach((cell=>{const input=cell.querySelector('[data-input="rfc"]');input&&(input.dataset.input="auto",input.value=input.dataset.oldvalue,input.dataset.rfcstate="0",cell.classList.remove("rfc"))})),this.sumtotals(),btn.classList.add("d-none")}async disableFormInput(form){const action=form.dataset.action,rowid=form.querySelector("#rowid").value,row=this.getRow(rowid);"data-disciplines"===action&&row.disciplines.length>=3||"data-competencies"===action&&row.competencies.length>=300?(form.querySelector('input[type="search"]').disabled=!0,form.querySelector('input[type="number"]').disabled=!0,form.querySelector('button[data-action="discipline-confirm"]').disabled=!0,form.querySelector('[data-region="warnings"]').innerHTML=await(0,_str.getString)("maxdisciplines","customfield_sprogramme",3)):(form.querySelector('input[type="search"]').disabled=!1,form.querySelector('input[type="number"]').disabled=!1,form.querySelector('button[data-action="discipline-confirm"]').disabled=!1,form.querySelector('[data-region="warnings"]').innerHTML="")}async addDiscipline(){const form=document.querySelector('[data-region="disciplineform"]'),action=form.dataset.action,discipline=await this.getSelectedDiscipline(form);if(!discipline)return;const rowid=form.querySelector("#rowid").value,row=this.getRow(rowid),containername="data-disciplines"===action?"container-disciplines":"container-competencies";let disciplineIndex=0,maxpercentage=100;if("data-disciplines"===action&&(disciplineIndex=row.disciplines.findIndex((d=>d.id==discipline.id)),maxpercentage=100-row.disciplines.reduce(((acc,comp)=>acc+parseInt(comp.percentage)),0)),"data-competencies"===action&&(disciplineIndex=row.competencies.findIndex((d=>d.id==discipline.id)),maxpercentage=100-row.competencies.reduce(((acc,disc)=>acc+parseInt(disc.percentage)),0)),discipline.percentage>maxpercentage)return void(form.querySelector('[data-region="warnings"]').innerHTML=await(0,_str.getString)("maxpercentage","customfield_sprogramme",maxpercentage));form.querySelector('[data-region="warnings"]').innerHTML="";const container=document.querySelector("[".concat(action,'][data-rowid="').concat(rowid,'"] [data-region="').concat(containername,'"]')),selectedcontainer=form.querySelector('[data-region="selected-disciplines"]');if(disciplineIndex>-1){"data-disciplines"===action&&(row.disciplines[disciplineIndex]=discipline),"data-competencies"===action&&(row.competencies[disciplineIndex]=discipline);const rendered=container.querySelector('[data-id="'+discipline.id+'"]'),selected=selectedcontainer.querySelector('[data-id="'+discipline.id+'"]'),{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/table/discipline",discipline);await _templates.default.replaceNode(rendered,html,js),await _templates.default.replaceNode(selected,html,js)}else{"data-disciplines"===action&&row.disciplines.push(discipline),"data-competencies"===action&&row.competencies.push(discipline);const{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/table/discipline",discipline);await _templates.default.appendNodeContents(container,html,js),await _templates.default.appendNodeContents(selectedcontainer,html,js)}this.disableFormInput(form)}async renderFormDisciplines(rowid,region){const row=this.getRow(rowid);let disciplines=[];"data-disciplines"===region&&(disciplines=row.disciplines),"data-competencies"===region&&(disciplines=row.competencies);const container=document.querySelector('[data-region="disciplineform"]').querySelector('[data-region="selected-disciplines"]');container.innerHTML="",disciplines.forEach((async discipline=>{const{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/table/discipline",discipline);_templates.default.appendNodeContents(container,html,js)}))}async removeDiscipline(btn){const form=document.querySelector('[data-region="disciplineform"]'),action=form.dataset.action,containername="data-disciplines"===action?"container-disciplines":"container-competencies",rowid=form.querySelector("#rowid").value,disciplineid=btn.closest("[data-id]").dataset.id;if("data-disciplines"===action){const row=this.getRow(rowid),index=row.disciplines.findIndex((d=>d.id==disciplineid));row.disciplines.splice(index,1)}if("data-competencies"===action){const row=this.getRow(rowid),index=row.competencies.findIndex((d=>d.id==disciplineid));row.competencies.splice(index,1)}const container=document.querySelector("[".concat(action,'][data-rowid="').concat(rowid,'"] [data-region="').concat(containername,'"]')),selectedcontainer=document.querySelector('[data-region="selected-disciplines"]'),discipline=container.querySelector('[data-id="'+disciplineid+'"]'),selected=selectedcontainer.querySelector('[data-id="'+disciplineid+'"]');container.removeChild(discipline),selectedcontainer.removeChild(selected),this.disableFormInput(form)}navigate(e){const currentIndex=e.target.closest("[data-row]").dataset.index,currentColumn=e.target.closest("[data-cell]").dataset.columnid,allRows=document.querySelectorAll("[data-row]");for(let i=0;i<allRows.length;i++)if(allRows[i].dataset.index==currentIndex){if("ArrowDown"===e.key&&i<allRows.length-1){const nextInput=allRows[i+1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));nextInput&&nextInput.focus()}if("ArrowUp"===e.key&&i>0){const previousInput=allRows[i-1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));previousInput&&previousInput.focus()}}if("ArrowRight"===e.key){const nextColumn=e.target.closest("[data-cell]").nextElementSibling;nextColumn&&nextColumn.focus()}if("ArrowLeft"===e.key){const previousColumn=e.target.closest("[data-cell]").previousElementSibling;previousColumn&&previousColumn.focus()}}}var _default={init:(element,courseid)=>{new Manager(element,courseid)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=manager.min.js.map