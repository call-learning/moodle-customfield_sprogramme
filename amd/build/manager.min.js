define("customfield_sprogramme/manager",["exports","customfield_sprogramme/local/state","customfield_sprogramme/local/repository","core/notification","core/str","core/utils","./local/components/table","./tagmanager","./programme_form"],(function(_exports,_state,_repository,_notification,_str,_utils,_table,_tagmanager,_programme_form){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_notification=_interopRequireDefault(_notification);class Manager{constructor(element,courseid){_defineProperty(this,"rowNumber",0),_defineProperty(this,"moduleNumber",0),_defineProperty(this,"courseid",void 0),_defineProperty(this,"element",void 0),_defineProperty(this,"table","customfield_sprogramme"),_defineProperty(this,"columns",[]),this.element=element,this.element.dataset.inintialized||(this.courseid=parseInt(courseid),this.addEventListeners(),this.getTableData(),this.element.dataset.inintialized=!0)}addEventListeners(){document.addEventListener("click",(e=>{let btn=e.target.closest(".modal-customfield_sprogramme_editor [data-action]");btn&&(e.preventDefault(),this.actions(btn))}));const form=document.querySelector('[data-region="app"]');form.addEventListener("change",(e=>{const input=e.target.closest('[data-input="auto"]');input&&this.change(input);const modulename=e.target.closest('[data-region="modulename"]');modulename&&this.changeModule(modulename)})),document.addEventListener("input",(function(e){if("TEXTAREA"===e.target.tagName){const textarea=e.target;textarea.style.height="auto",textarea.style.height="".concat(textarea.scrollHeight+1,"px"),textarea.dataset.height=textarea.scrollHeight+1}})),form.addEventListener("keydown",(e=>{"ArrowDown"!==e.key&&"ArrowUp"!==e.key||(this.navigate(e),e.preventDefault())})),form.addEventListener("submit",(e=>{e.preventDefault()}));let dragging=null;form.addEventListener("dragstart",(e=>{const handle=e.target.closest('[data-region="dragicon"]');handle?(dragging=handle.closest("tr"),e.dataTransfer.effectAllowed="move"):e.preventDefault()})),form.addEventListener("dragover",(e=>{e.preventDefault();const target=e.target.closest("tr");if(target&&target!==dragging&&"rows"===target.parentNode.dataset.region){const rect=target.getBoundingClientRect();e.clientY-rect.top>rect.height/2?target.parentNode.insertBefore(dragging,target.nextSibling):target.parentNode.insertBefore(dragging,target)}})),form.addEventListener("drop",(e=>{e.preventDefault()})),form.addEventListener("dragend",(e=>{const rowId=dragging.dataset.index,prevRowId=dragging.previousElementSibling?dragging.previousElementSibling.dataset.index:0,moduleId=dragging.closest('[data-region="module"]').dataset.id;this.moveRow(parseInt(moduleId),parseInt(rowId),prevRowId?parseInt(prevRowId):null),dragging=null,e.preventDefault()}))}async getTableData(){try{const response=await _repository.default.getData({courseid:this.courseid,showrfc:1});if(response.modules.length>0){const modules=this.parseModules(response),columns=response.columns;_state.default.setValue("columns",[...columns]),_state.default.setValue("modules",modules),_state.default.setValue("rfc",response.rfc),_state.default.setValue("editbuttons",{courseid:this.courseid,canedit:response.canedit}),this.sumtotals()}else{const response=await _repository.default.getColumns({courseid:this.courseid}),columns=response.columns;_state.default.setValue("columns",[...columns]),_state.default.setValue("modules",[]),_state.default.setValue("rfc",[]),_state.default.setValue("editbuttons",{courseid:this.courseid,canedit:response.canedit}),this.addModule()}}catch(error){_notification.default.exception(error)}}parseModules(response){return response.modules.forEach((mod=>{mod.editor=response.canedit,mod.rows.map((row=>(row.cells=row.cells.map((cell=>{const column=response.columns.find((column=>column.column==cell.column));return"select"===(cell=Object.assign({},cell,column)).type&&(cell.options=cell.options.map((option=>{const clonedOption=Object.assign({},option);return clonedOption.name==cell.value&&(clonedOption.selected=!0),clonedOption}))),cell.changed=cell.value!==cell.oldvalue,cell})),row)))})),response.modules}getRowObject(){return{rows:{id:"id",sortorder:"sortorder",deleted:"false",todelete:"false",cells:{type:"type",column:"column",value:"value",group:"group",oldvalue:"oldvalue"},disciplines:{id:"id",name:"name",percentage:"percentage"},competencies:{id:"id",name:"name",percentage:"percentage"}}}}checkCellValue(cell){null!==cell.value&&"text"===cell.type&&cell.value.length>cell.length&&(cell.value=cell.value.substring(0,cell.length))}cleanCell(cell,cellKeys){const cleaned={};return this.checkCellValue(cell),cellKeys.forEach((key=>{cleaned[key]=cell[key]})),cleaned}cleanList(items,allowedKeys){return items.map((item=>{const cleaned={};return allowedKeys.forEach((key=>{cleaned[key]=item[key]})),cleaned}))}validateModules(){const modules=_state.default.getValue("modules");let result=!0;return 0===modules.length?(result=!1,result):(modules.forEach((module=>{module.modulename&&""!==module.modulename.trim()||(module.error=!0),module.rows.forEach((row=>{row.deleted||(0===row.cells.length?(row.error=!0,result=!1):this.checkRow(row)||(result=!1))}))})),_state.default.setValue("modules",modules),result)}checkRow(row){const groups={};let result=!0;return row.cells.forEach((cell=>{cell.group&&(groups[cell.group]||(groups[cell.group]=[]),cell.value&&cell.value>0&&groups[cell.group].push(cell))})),Object.keys(groups).forEach((group=>{groups[group].length>1?(groups[group].forEach((cell=>{cell.error=!0})),row.error=!0,result=!1):0===groups[group].length?(row.error=!0,result=!1):row.error=!1})),result}cleanModules(modules){const rowSpec=this.getRowObject().rows;return modules.map((module=>({moduleid:module.moduleid,modulename:module.modulename,modulesortorder:module.modulesortorder,deleted:module.deleted||!1,rows:module.rows.map((row=>({id:row.id,sortorder:row.sortorder,deleted:row.deleted||!1,cells:this.cleanList(row.cells,Object.keys(rowSpec.cells)),disciplines:this.cleanList(row.disciplines,Object.keys(rowSpec.disciplines)),competencies:this.cleanList(row.competencies,Object.keys(rowSpec.competencies))})))})))}async setTableData(){(0,_utils.debounce)((async()=>{const saveConfirmButton=document.querySelector('[data-action="saveconfirm"]');if(saveConfirmButton.classList.add("saving"),!this.validateModules())return"";const modules=_state.default.getValue("modules"),cleanedModules=this.cleanModules(modules);if(await _repository.default.setData({courseid:this.courseid,modules:cleanedModules})){this.getTableData();const update=await _repository.default.getData({courseid:this.courseid,showrfc:0}),modulesStatic=this.parseModules(update);_state.default.setValue("modulesstatic",modulesStatic)}else _notification.default.exception("No response from the server");setTimeout((()=>{saveConfirmButton.classList.remove("saving")}),200)}),600)()}actions(btn){const actionMap={addrow:this.addRow,deleterow:this.deleteRow,addmodule:this.addModule,deletemodule:this.deleteModule,saveconfirm:this.setTableData,showchanges:this.showchanges,closechanges:this.closeChanges,acceptrfc:this.acceptRfc,rejectrfc:this.rejectRfc,submitrfc:this.submitRfc,cancelrfc:this.cancelRfc,removerfc:this.removeRfc,resetrfc:this.resetRfc,closeform:this.closeForm,downloadcsv:this.downloadCsv,augmenttable:this.augmentTable},action=btn.dataset.action;actionMap[action]&&actionMap[action].call(this,btn)}async addRow(btn){const modules=_state.default.getValue("modules");let rowid=btn.dataset.id;const moduleid=btn.closest('[data-region="module"]').dataset.id,rows=modules.find((m=>m.moduleid==moduleid)).rows;-1==rowid&&(rowid=rows[rows.length-1].id);const row=await this.createRow();row&&(rows.splice(rows.indexOf(rows.find((r=>r.id==rowid)))+1,0,row),this.resetRowSortorder(),_state.default.setValue("modules",modules))}createRow(){const row={};this.rowNumber=this.rowNumber-1,row.id=this.rowNumber;const columns=_state.default.getValue("columns");return row.cells=columns.map((column=>structuredClone(column))),row.cells.forEach((cell=>{cell.edit=!0,cell.value=null,cell[cell.type]=!0,cell.oldvalue=null,cell.changed=!1})),row.disciplines=[],row.competencies=[],row}async deleteRow(btn){const modules=_state.default.getValue("modules"),rowid=parseInt(btn.closest("[data-row]").dataset.index),moduleid=parseInt(btn.closest('[data-region="module"]').dataset.id),modulefound=modules.find((m=>m.moduleid==moduleid));if(modulefound.rows.length>0){const rowIndex=modulefound.rows.findIndex((r=>r.id==rowid));-1!==rowIndex?(rowid>0?(modulefound.rows[rowIndex].deleted=!0,modulefound.rows[rowIndex].cells.forEach((cell=>{null===cell.value||"float"!=cell.type&&"number"!=cell.type||(cell.changed=!0,cell.value=null)}))):modulefound.rows.splice(rowIndex,1),_state.default.setValue("modules",modules)):_notification.default.exception("Row not found")}this.sumtotals()}change(input){const row=input.closest("[data-row]"),cell=input.closest("[data-cell]"),group=input.dataset.group,value=input.value,columnid=parseInt(cell.dataset.columnid),index=parseInt(row.dataset.index),modules=_state.default.getValue("modules");modules.forEach((module=>{const rowIndex=module.rows.findIndex((r=>r.id==index));if(-1===rowIndex)return;const cellIndex=module.rows[rowIndex].cells.findIndex((c=>c.columnid==columnid)),cell=module.rows[rowIndex].cells[cellIndex];cell.value=value||null,input.dataset.height&&(cell.height=input.dataset.height),group&&module.rows[rowIndex].cells.forEach((c=>{c.group===group&&c.columnid!==columnid&&null!==c.value&&(c.value=null)})),"select"==cell.type&&cell.options.forEach((option=>{option.selected=option.name===value}))})),this.markchanges(),this.sumtotals(),_state.default.setValue("modules",modules)}markchanges(){const modules=_state.default.getValue("modules");modules.forEach((module=>{module.rows.forEach((row=>{row.cells.forEach((cell=>{cell.changed=cell.value!=cell.oldvalue}))}))})),_state.default.setValue("modules",modules)}sumtotals(){const columnsData=_state.default.getValue("columns");columnsData.forEach((column=>{column.sum=0,column.newsum=0,column.hasnewsum=!1,column.changed=!1}));const modules=_state.default.getValue("modules");let overaltotals=0,newsumtotals=0;modules.forEach((module=>{module.rows.forEach((row=>{row.cells.forEach((cell=>{if("number"===cell.type||"float"===cell.type){const column=columnsData.find((c=>c.columnid===cell.columnid));column&&(cell.changed?column.sum=(parseFloat(column.sum)||0)+parseFloat(cell.oldvalue):cell.value&&null!==cell.value&&(column.sum=(parseFloat(column.sum)||0)+parseFloat(cell.value)),cell.value&&(column.newsum=(parseFloat(column.newsum)||0)+parseFloat(cell.value),column.hasnewsum=!0),0==column.sum&&column.newsum>0&&(column.hasnewsum=!0,column.sum=" 0")),cell.changed&&(column.changed=!0)}}))}))}));let totalsChanged=!1;columnsData.forEach((column=>{"number"!==column.type&&"float"!==column.type||(totalsChanged=totalsChanged||column.changed,overaltotals+=parseFloat(column.sum)||0,newsumtotals+=parseFloat(column.newsum)||0)})),columnsData[0].overaltotals=overaltotals,columnsData[0].newsumtotals=newsumtotals,columnsData[0].totalschanged=totalsChanged,_state.default.setValue("columns",columnsData)}changeModule(input){const moduleid=input.closest('[data-region="module"]').dataset.id,name=input.value;_state.default.getValue("modules").forEach((module=>{module.moduleid==moduleid&&(module.modulename=name)}))}async deleteModule(btn){const moduleid=btn.closest('[data-region="module"]').dataset.id,modules=_state.default.getValue("modules"),moduleIndex=modules.findIndex((m=>m.moduleid==moduleid));-1!==moduleIndex&&(modules[moduleIndex].deleted=!0,modules[moduleIndex].rows.forEach((row=>{row.deleted=!0,row.cells.forEach((cell=>{null===cell.value||"float"!=cell.type&&"number"!=cell.type||(cell.changed=!0,cell.value=null)}))})),_state.default.setValue("modules",modules))}createModule(){return this.moduleNumber=this.moduleNumber-1,this.moduleNumber}addModule(){const modules=_state.default.getValue("modules"),module={moduleid:this.createModule(),modulename:" ",deleted:!1,editor:!0,rows:[this.createRow()]};modules.push(module),this.resetRowSortorder(),_state.default.setValue("modules",modules)}getRow(rowid){return _state.default.getValue("modules").reduce(((acc,module)=>acc.concat(module.rows)),[]).find((r=>r.id==rowid))}moveRow(moduleId,rowId,prevRowId){const modules=_state.default.getValue("modules"),module=modules.find((m=>m.moduleid===moduleId));if(!module)return;const rows=module.rows,rowIndex=rows.findIndex((r=>r.id===rowId));if(-1===rowIndex)return;const[rowToMove]=rows.splice(rowIndex,1);let insertIndex=0;if(null!==prevRowId){insertIndex=rows.findIndex((r=>r.id===prevRowId))+1}rows.splice(insertIndex,0,rowToMove),rows.forEach(((row,index)=>{row.sortorder=index+1})),_state.default.setValue("modules",modules)}resetRowSortorder(){const modules=_state.default.getValue("modules");modules.forEach(((module,mindex)=>{module.modulesortorder=mindex,module.rows.forEach(((row,index)=>{row.sortorder=index}))})),_state.default.setValue("modules",modules)}async showchanges(btn){document.querySelectorAll('[data-action="showchanges"]').forEach((td=>{td!==btn&&td.classList.remove("active")})),btn.classList.add("active")}async closeChanges(){document.querySelectorAll('[data-action="showchanges"]').forEach((td=>{td.classList.remove("active")}))}async acceptRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;if(await _repository.default.acceptRfc({courseid:this.courseid,userid:userid})){this.getTableData();const update=await _repository.default.getData({courseid:this.courseid,showrfc:0}),modulesStatic=this.parseModules(update);_state.default.setValue("modulesstatic",modulesStatic)}}async rejectRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.rejectRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async submitRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.submitRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async cancelRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.cancelRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async removeRfc(btn){const userid=btn.closest("[data-rfc]").dataset.userid;await _repository.default.removeRfc({courseid:this.courseid,userid:userid})&&this.getTableData()}async resetRfc(btn){document.querySelector('[data-region="app"]').querySelectorAll('[data-action="showchanges"]').forEach((cell=>{const input=cell.querySelector('[data-input="rfc"]');input&&(input.dataset.input="auto",input.value=input.dataset.oldvalue,input.dataset.rfcstate="0",cell.classList.remove("rfc"))})),this.sumtotals(),btn.classList.add("d-none")}async augmentTable(btn){const modules=_state.default.getValue("modules");modules.forEach((module=>{module.rows.forEach((row=>{row.cells.forEach((cell=>{cell.oldvalue!=cell.value?(cell.changes={oldvalue:cell.oldvalue?cell.oldvalue:"0",newvalue:cell.value},cell.changed=!0):(cell.changes=null,cell.changed=!1)}))}))})),_state.default.setValue("modules",modules),btn.classList.add("active")}async closeForm(){const modules=_state.default.getValue("modules"),rfc=_state.default.getValue("rfc"),event=new CustomEvent("closeform",{bubbles:!0,composed:!0});if(rfc&&rfc.issubmitted)return void document.dispatchEvent(event);const confirmationStrings=await(0,_str.getStrings)([{key:"confirm",component:"customfield_sprogramme"},{key:"unsavedchanges",component:"customfield_sprogramme"},{key:"closewithoutsaving",component:"customfield_sprogramme"},{key:"cancel",component:"customfield_sprogramme"}]);modules.some((module=>module.rows.some((row=>row.cells.some((cell=>cell.changed))))))?_notification.default.confirm(...confirmationStrings,(()=>{document.dispatchEvent(event)}),(()=>{})):document.dispatchEvent(event)}async downloadCsv(){const csv=await _repository.default.csvData({courseid:this.courseid}),blob=new Blob([csv.csv],{type:"text/csv"}),url=window.URL.createObjectURL(blob),a=document.createElement("a");a.href=url,a.download=csv.filename,a.click(),window.URL.revokeObjectURL(url)}navigate(e){const currentIndex=e.target.closest("[data-row]").dataset.index,currentColumn=e.target.closest("[data-cell]").dataset.columnid,allRows=document.querySelectorAll("[data-row]");for(let i=0;i<allRows.length;i++)if(allRows[i].dataset.index==currentIndex){if("ArrowDown"===e.key&&i<allRows.length-1){const nextInput=allRows[i+1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));nextInput&&nextInput.focus()}if("ArrowUp"===e.key&&i>0){const previousInput=allRows[i-1].querySelector('[data-columnid="'.concat(currentColumn,'"] input'));previousInput&&previousInput.focus()}}if("ArrowRight"===e.key){const nextColumn=e.target.closest("[data-cell]").nextElementSibling;nextColumn&&nextColumn.focus()}if("ArrowLeft"===e.key){const previousColumn=e.target.closest("[data-cell]").previousElementSibling;previousColumn&&previousColumn.focus()}}}var _default={init:(element,courseid)=>{new Manager(element,courseid)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=manager.min.js.map