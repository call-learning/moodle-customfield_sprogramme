define("customfield_sprogramme/manager",["exports","customfield_sprogramme/local/state","customfield_sprogramme/local/repository","core/notification","core/utils","./local/components/table"],(function(_exports,_state,_repository,_notification,_utils,_table){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_notification=_interopRequireDefault(_notification);class Manager{constructor(courseid){_defineProperty(this,"rowNumber",0),_defineProperty(this,"courseid",void 0),_defineProperty(this,"table","customfield_sprogramme"),this.courseid=parseInt(courseid),this.addEventListeners(),this.getDatagrid()}async getDatagrid(){await this.getTableConfig(),await this.getTableData()}async getTableConfig(){try{const response=await _repository.default.getColumns({table:this.table}),json=this.parseResponse(response);json?await _state.default.setValue("columns",json):_notification.default.exception("The response is not valid JSON")}catch(error){_notification.default.exception(error)}}async getTableData(){try{const response=await _repository.default.getData({courseid:this.courseid});if(response.rows.length>0){const rows=this.parseRows(response.rows);_state.default.setValue("rows",rows)}else{const row=await this.createRow(0);_state.default.setValue("rows",[row]),this.resetRowSortorder()}}catch(error){_notification.default.exception(error)}}parseRows(rows){const columns=_state.default.getValue("columns");return rows.map((row=>(row.cells=row.cells.map((cell=>{const column=columns.find((column=>column.column==cell.column));return(cell=Object.assign({},cell,column))[cell.type]=!0,cell.edit=!0,cell})),row)))}getRowObject(){return{rows:{id:"id",sortorder:"sortorder",cells:{type:"type",column:"column",value:"value"}}}}cleanRows(rows){const rowObject=this.getRowObject(),cleanedRows=rows.map((row=>{const cleanedRow={};return Object.keys(rowObject.rows).forEach((key=>{cleanedRow[key]=row[key]})),cleanedRow.cells=row.cells.map((cell=>{const cleanedCell={};return Object.keys(rowObject.rows.cells).forEach((key=>{cleanedCell[key]=cell[key]})),cleanedCell})),cleanedRow}));return window.console.log(JSON.stringify(cleanedRows)),cleanedRows}async setTableData(){(0,_utils.debounce)((async()=>{try{const rows=_state.default.getValue("rows");await _repository.default.setData({courseid:this.courseid,rows:this.cleanRows(rows)})||_notification.default.exception("No response from the server")}catch(error){_notification.default.exception("Error 2"+error)}}),600)()}async createRow(index){const rowid=await _repository.default.createRow({courseid:this.courseid,sortorder:index});return new Promise((resolve=>{const row={};row.id=rowid,row.sortorder=index;const columns=_state.default.getValue("columns");void 0!==columns?(row.cells=columns.map((column=>structuredClone(column))),row.cells.forEach((cell=>{cell.edit=!0,cell.value="",cell[cell.type]=!0})),resolve(row)):resolve()}))}async delete(btn){const rowid=btn.closest("[data-row]").dataset.index,response=await _repository.default.deleteRow({rowid:rowid});return new Promise((resolve=>{if(response.success){const rows=_state.default.getValue("rows"),index=Array.from(btn.closest('[data-region="rows"]').children).indexOf(btn.closest("[data-row]"));rows.splice(index,1),this.resetRowSortorder(),_state.default.setValue("rows",rows)}resolve(rowid)}))}resetRowSortorder(){const rows=_state.default.getValue("rows");rows.forEach(((row,index)=>{row.sortorder=index})),_state.default.setValue("rows",rows)}addEventListeners(){document.addEventListener("click",(e=>{let btn=e.target.closest("[data-action]");btn&&(e.preventDefault(),this.actions(btn))})),document.addEventListener("change",(e=>{const input=e.target.closest("[data-input]");input&&this.change(input)}))}actions(btn){"add"===btn.dataset.action&&this.add(btn),"edit"===btn.dataset.action&&this.edit(btn),"save"===btn.dataset.action&&(this.save(),this.stopEdit()),"delete"===btn.dataset.action&&this.delete(btn),this.setTableData()}change(input){const row=input.closest("[data-row]"),cell=input.closest("[data-cell]"),value=input.value,columnid=cell.dataset.columnid,index=row.dataset.index,rows=_state.default.getValue("rows"),rowIndex=rows.findIndex((r=>r.id==index)),cellIndex=rows[rowIndex].cells.findIndex((c=>c.columnid==columnid));rows[rowIndex].cells[cellIndex].value=value,this.setTableData()}async add(btn){const rows=_state.default.getValue("rows"),tablerows=document.querySelectorAll('[data-region="rows"] [data-row]'),index=Array.from(tablerows).indexOf(btn.closest("[data-row]")),row=await this.createRow(index+1);rows.splice(index+1,0,row),this.resetRowSortorder(),_state.default.setValue("rows",rows)}parseResponse(response){if("string"==typeof response.data)try{return JSON.parse(response.data)}catch(error){return}}}var _default={init:courseid=>{new Manager(courseid)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=manager.min.js.map