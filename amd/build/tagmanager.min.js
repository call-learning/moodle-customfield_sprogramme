define("customfield_sprogramme/tagmanager",["customfield_sprogramme/local/state","customfield_sprogramme/local/repository","core/templates","core/str"],(function(_state,_repository,_templates,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_templates=_interopRequireDefault(_templates);new class{constructor(){var obj,key,value;value=[],(key="modules")in(obj=this)?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,this.addEventListeners(),this.fetchTags()}async setModules(modules){this.modules=modules}async fetchTags(){const tags=await _repository.default.getTags();_state.default.setValue("tags",tags)}addEventListeners(){document.addEventListener("click",(e=>{let btn=e.target.closest('[data-region="app"] [data-action]');btn&&(e.preventDefault(),this.actions(btn))}))}actions(btn){const actionMap={adddisc:this.showDisciplineForm,addcomp:this.showCompetenciesForm,removetag:this.removeTag,closetagform:this.closeTagForm,selecttag:this.selectTag,"tag-confirm":this.addTag,loadtag:this.loadTag},action=btn.dataset.action;actionMap[action]&&actionMap[action].call(this,btn)}getTargetRow(rowId){const modules=_state.default.getValue("modules");if(!modules||0===modules.length)return 0;for(const module of modules){const rowFound=module.rows.find((row=>row.id===parseInt(rowId)));if(rowFound){const position=module.rows.indexOf(rowFound);if(position<8){const row=module.rows[0];return row?row.id:0}return module.rows[position-8].id}}return 0}getRow(rowid){return _state.default.getValue("modules").reduce(((acc,module)=>acc.concat(module.rows)),[]).find((r=>r.id==rowid))}getTagsFromRow(rowId,type){const row=this.getRow(rowId);return row&&row[type]?row[type]:[]}async showDisciplineForm(btn){const rowId=btn.dataset.id;this.renderForm(rowId,"disciplines")}async showCompetenciesForm(btn){const rowId=btn.dataset.id;this.renderForm(rowId,"competencies")}async renderForm(rowId,type){const setTags=this.getTagsFromRow(rowId,type),position=this.getTargetRow(rowId),tags=_state.default.getValue("tags"),target=document.querySelector("[data-".concat(type,'][data-rowid="').concat(position,'"]')),maxTagsReached=this.isMaxTagsReached(rowId,type),{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/tagform",{tagtype:type,taglist:tags[type],rowid:rowId,settags:setTags,hasmaxtags:maxTagsReached});await _templates.default.appendNodeContents(target,html,js)}isMaxTagsReached(rowId,type){const row=this.getRow(rowId);if(!row||!row[type])return!1;return row[type].length>={disciplines:3,competencies:100}[type]}closeTagForm(){const form=document.querySelector('[data-region="tagform"]');form&&form.remove()}setTagForm(tag){const form=document.querySelector('[data-region="tagform"]');if(!form)return;const input=form.querySelector('input[type="search"]');input&&(input.value=tag.name);const tagId=form.querySelector("#tag-id");tagId&&(tagId.value=tag.id);const select=form.querySelector("#tag-value");select&&select.focus()}selectTag(btn){const option=btn.closest("[data-option]"),tag={id:option.dataset.id,name:option.textContent};this.setTagForm(tag)}getTag(tagId,type){const tags=_state.default.getValue("tags");if(!tags||!tags[type])return null;return tags[type].reduce(((acc,tag)=>(acc.push(tag),tag.items&&tag.items.length>0&&acc.push(...tag.items),acc)),[]).find((tag=>tag.uniqueid===parseInt(tagId)||tag.id===parseInt(tagId)))}async addTag(){const modules=_state.default.getValue("modules"),form=document.querySelector('[data-region="tagform"]'),warnings=form.querySelector('[data-region="warnings"]');if(!form)return;const rowId=form.dataset.rowid,type=form.dataset.type,tagId=parseInt(form.querySelector("#tag-id").value),tagValue=parseInt(form.querySelector("#tag-value").value);if(!tagId||!tagValue)return;const selectedTag=this.getTag(tagId,type);if(!selectedTag)return;const row=this.getRow(rowId);if(!row)return;row[type]||(row[type]=[]);const maxPercentage=100-row[type].reduce(((acc,tag)=>acc+parseInt(tag.percentage)),0);if(parseInt(tagValue)>maxPercentage)return void(warnings.innerHTML=await(0,_str.getString)("maxpercentage","customfield_sprogramme",maxPercentage));warnings.innerHTML="";const existingTags=this.getTagsFromRow(rowId,type);existingTags||(row[type]=[]);const existingTag=existingTags.find((tag=>tag.id===tagId||tag.uniqueid===tagId));if(existingTag)existingTag.percentage=tagValue;else{const tag={id:tagId,name:selectedTag?selectedTag.name:"Unknown",percentage:tagValue};row[type].push(tag)}_state.default.setValue("modules",modules)}async removeTag(btn){const form=document.querySelector('[data-region="tagform"]');if(!form)return;const type=form.dataset.type,rowId=parseInt(form.dataset.rowid),tagId=parseInt(btn.dataset.id),modules=_state.default.getValue("modules"),row=this.getRow(rowId);row&&row[type]&&(row[type]=row[type].filter((tag=>tag.id!==parseInt(tagId))),_state.default.setValue("modules",modules))}async loadTag(btn){const form=document.querySelector('[data-region="tagform"]');form&&(form.querySelector("#tag-id").value=btn.dataset.id,form.querySelector("#tag-value").value=btn.dataset.percentage,form.querySelector("#tag-name").value=btn.dataset.name,form.querySelector("#tag-value").focus())}disableFormInput(){let disable=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const form=document.querySelector('[data-region="tagform"]');if(!form)return;const input=form.querySelector("#tag-name");input&&(input.disabled=disable);const value=form.querySelector("#tag-value");value&&(value.disabled=disable);const submit=form.querySelector('[data-action="tag-confirm"]');submit&&(submit.disabled=disable)}}}));

//# sourceMappingURL=tagmanager.min.js.map