define("customfield_sprogramme/tagmanager",["customfield_sprogramme/local/state","customfield_sprogramme/local/repository","core/templates","core/str"],(function(_state,_repository,_templates,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}_state=_interopRequireDefault(_state),_repository=_interopRequireDefault(_repository),_templates=_interopRequireDefault(_templates);new class{constructor(){_defineProperty(this,"modules",[]),_defineProperty(this,"tempTags",[]),this.addEventListeners(),this.fetchTags()}async setModules(modules){this.modules=modules}async fetchTags(){const tags=await _repository.default.getTags();_state.default.setValue("tags",tags)}addEventListeners(){document.addEventListener("click",(e=>{let btn=e.target.closest('[data-region="app"] [data-action]');btn&&(e.preventDefault(),this.actions(btn))}))}actions(btn){const actionMap={adddisc:this.showDisciplineForm,addcomp:this.showCompetenciesForm,removetag:this.removeTag,closetagform:this.closeTagForm,selecttag:this.selectTag,"tag-confirm":this.addTag,loadtag:this.loadTag,savetags:this.saveTags},action=btn.dataset.action;actionMap[action]&&actionMap[action].call(this,btn)}getTargetRow(rowId){const modules=_state.default.getValue("modules");if(!modules||0===modules.length)return 0;for(const module of modules){const rowFound=module.rows.find((row=>row.id===parseInt(rowId)));if(rowFound){const position=module.rows.indexOf(rowFound);if(position<6){const row=module.rows[0];return row?row.id:0}return module.rows[position-6].id}}return 0}getRowOffset(rowId,position,type){if(parseInt(rowId)===position||0===position)return 0;const target=document.querySelector("[data-".concat(type,'][data-rowid="').concat(position,'"]')),row=document.querySelector("[data-".concat(type,'][data-rowid="').concat(rowId,'"]'));if(!target||!row)return 0;const targetRect=target.getBoundingClientRect();return row.getBoundingClientRect().top-targetRect.top}getRow(rowid){return _state.default.getValue("modules").reduce(((acc,module)=>acc.concat(module.rows)),[]).find((r=>r.id==rowid))}getTagsFromRow(rowId,type){const row=this.getRow(rowId);return row&&row[type]?(row[type].forEach((tag=>{tag.nopop=!0})),row[type]):[]}async showDisciplineForm(btn){const rowId=btn.dataset.id;this.closeTagForm(),this.renderForm(rowId,"disciplines")}async showCompetenciesForm(btn){const rowId=btn.dataset.id;this.closeTagForm(),this.renderForm(rowId,"competencies")}async renderForm(rowId,type){const setTags=this.getTagsFromRow(rowId,type);this.tempTags=[...setTags];const position=this.getTargetRow(rowId),arrowOffset=this.getRowOffset(rowId,position,type),tags=_state.default.getValue("tags"),target=document.querySelector("[data-".concat(type,'][data-rowid="').concat(position,'"]')),maxTagsReached=this.isMaxTagsReached(type),{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/tagform",{tagtype:type,taglist:tags[type],rowid:rowId,settags:this.tempTags,hasmaxtags:maxTagsReached,arrowoffset:arrowOffset});await _templates.default.appendNodeContents(target,html,js)}isMaxTagsReached(type){return this.tempTags.length>={disciplines:3,competencies:5}[type]}closeTagForm(){const form=document.querySelector('[data-region="tagform"]');form&&form.remove()}setTagForm(tag){const form=document.querySelector('[data-region="tagform"]'),setTags=this.tempTags;if(!form)return;const input=form.querySelector('input[type="search"]');input&&(input.value=tag.name);const tagId=form.querySelector("#tag-id");tagId&&(tagId.value=tag.id);const select=form.querySelector("#tag-value"),percentage=setTags.length>0?Math.floor(100/(setTags.length+1)):100;select&&(select.value=percentage,select.focus())}selectTag(btn){const option=btn.closest("[data-option]"),tag={id:option.dataset.id,name:option.textContent};this.setTagForm(tag)}getTag(tagId,type){const tags=_state.default.getValue("tags");if(!tags||!tags[type])return null;return tags[type].reduce(((acc,tag)=>(acc.push(tag),tag.items&&tag.items.length>0&&acc.push(...tag.items),acc)),[]).find((tag=>tag.uniqueid===parseInt(tagId)||tag.id===parseInt(tagId)))}async addTag(){const form=document.querySelector('[data-region="tagform"]'),warnings=form.querySelector('[data-region="warnings"]');if(warnings.innerHTML="",!form)return;const rowId=form.dataset.rowid,type=form.dataset.type,tagId=parseInt(form.querySelector("#tag-id").value),tagValue=parseInt(form.querySelector("#tag-value").value),totalTags=this.tempTags.length,suggestedPercentage=Math.floor(100/(totalTags+1));if(!tagId)return;const selectedTag=this.getTag(tagId,type);if(!selectedTag)return;const row=this.getRow(rowId);if(!row)return;row[type]||(row[type]=[]);if(this.tempTags.some((tag=>tag.id===tagId)))return void(warnings.innerHTML=await(0,_str.getString)("alreadyset","customfield_sprogramme"));if(this.isMaxTagsReached(type))return void(warnings.innerHTML=await(0,_str.getString)("maxdisciplines","customfield_sprogramme"));const tag={id:tagId,name:selectedTag?selectedTag.name:"Unknown",percentage:tagValue,customPercentage:tagValue!==suggestedPercentage,nopop:!0};this.tempTags.push(tag),this.resetTagPercentages(),this.reRenderSetTags(),this.disableFormInput(this.isMaxTagsReached(type))}resetTagPercentages(){const totalTags=this.tempTags.length;if(0===totalTags)return;if(this.tempTags.some((tag=>tag.customPercentage)))return;const percentage=Math.floor(100/totalTags);this.tempTags.forEach((tag=>{tag.percentage=percentage})),totalTags>0&&(this.tempTags[totalTags-1].percentage=100-percentage*(totalTags-1))}async reRenderSetTags(){const form=document.querySelector('[data-region="tagform"]');if(!form)return;const tagRegion=form.querySelector('[data-region="selected-tags"]');if(tagRegion){tagRegion.innerHTML="";for(const tag of this.tempTags){const{html:html,js:js}=await _templates.default.renderForPromise("customfield_sprogramme/table/tag",tag);await _templates.default.appendNodeContents(tagRegion,html,js)}}}async removeTag(btn){const form=document.querySelector('[data-region="tagform"]');if(form.querySelector('[data-region="warnings"]').innerHTML="",!form)return;const type=form.dataset.type,rowId=parseInt(form.dataset.rowid),tagId=parseInt(btn.dataset.id),row=this.getRow(rowId);row&&row[type]&&(this.tempTags=this.tempTags.filter((tag=>tag.id!==parseInt(tagId))),this.resetTagPercentages(),this.reRenderSetTags(),this.disableFormInput(this.isMaxTagsReached(type)))}async loadTag(btn){const form=document.querySelector('[data-region="tagform"]');form&&(form.querySelector("#tag-id").value=btn.dataset.id,form.querySelector("#tag-value").value=btn.dataset.percentage,form.querySelector("#tag-name").value=btn.dataset.name,form.querySelector("#tag-value").focus())}async saveTags(){const modules=_state.default.getValue("modules"),form=document.querySelector('[data-region="tagform"]'),warnings=form.querySelector('[data-region="warnings"]');if(warnings.innerHTML="",!form)return;const rowId=form.dataset.rowid,type=form.dataset.type,row=this.getRow(rowId),totalPercentage=this.tempTags.reduce(((acc,tag)=>acc+tag.percentage),0);100===totalPercentage||99===totalPercentage?row&&(row[type]=this.tempTags,_state.default.setValue("modules",modules)):warnings.innerHTML=await(0,_str.getString)("maxpercentage","customfield_sprogramme",100-totalPercentage)}async disableFormInput(){let disable=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const form=document.querySelector('[data-region="tagform"]'),warnings=form.querySelector('[data-region="warnings"]');if(warnings.innerHTML="",!form)return;const input=form.querySelector("#tag-name");input&&(input.disabled=disable);const value=form.querySelector("#tag-value");value&&(value.disabled=disable);const submit=form.querySelector('[data-action="tag-confirm"]');submit&&(submit.disabled=disable),disable&&(warnings.innerHTML=await(0,_str.getString)("maxdisciplines","customfield_sprogramme"))}}}));

//# sourceMappingURL=tagmanager.min.js.map